<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 실시간 온습도</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- MQTT over WebSocket (Paho) -->
  <script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; padding: 24px; }
    .card { max-width: 560px; margin: 0 auto; border: 1px solid #ddd; border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 12px; margin: 8px 0; align-items: baseline; }
    .label { width: 110px; color: #666; }
    .value { font-weight: 700; font-size: 20px; }
    .ok { color: #1b7f1b; }
    .err { color: #c62828; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; }
    code { font-size: 12px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ESP32 실시간 온습도</h1>

    <div class="row">
      <span class="label">브로커 상태</span>
      <span id="status" class="value err"><span class="dot" style="background:#c62828"></span>DISCONNECTED</span>
    </div>

    <div class="row">
      <span class="label">Topic</span>
      <span class="value" id="topic">ewha/0317137263</span>
    </div>

    <div class="row">
      <span class="label">온도</span>
      <span class="value" id="temp">--.- °C</span>
    </div>

    <div class="row">
      <span class="label">습도</span>
      <span class="value" id="hum">--.- %</span>
    </div>

    <div class="row">
      <span class="label">최근 수신</span>
      <span class="value" id="ts">--</span>
    </div>

    <div class="row">
      <span class="label">원본 JSON</span>
      <span id="raw" class="value" style="font-weight:400; font-size:14px;"><code>(대기중)</code></span>
    </div>
  </div>

  <script>
    // ============
    const TOPIC   = "ewha/1970044";
    const USE_SSL = true;        // GitHub Pages는 https이므로 가능하면 true(WSS) 권장
    const HOST    = "damoa.io";  // 브로커 호스트
    const PORT    = 8084;        //
    const PATH    = "/mqtt";     //
    const elStatus = document.getElementById('status');
    const elTemp   = document.getElementById('temp');
    const elHum    = document.getElementById('hum');
    const elTs     = document.getElementById('ts');
    const elRaw    = document.getElementById('raw');

    function setStatus(connected) {
      if (connected) {
        elStatus.classList.remove('err');
        elStatus.classList.add('ok');
        elStatus.innerHTML = '<span class="dot" style="background:#1b7f1b"></span>CONNECTED';
      } else {
        elStatus.classList.remove('ok');
        elStatus.classList.add('err');
        elStatus.innerHTML = '<span class="dot" style="background:#c62828"></span>DISCONNECTED';
      }
    }

    function tsToString(ts) {
      if (!ts || isNaN(ts)) return new Date().toLocaleString();
      return new Date(Number(ts) * 1000).toLocaleString();
    }

    // Paho MQTT WebSocket 클라이언트
    const clientId = "web-sub-0317137263-" + Math.random().toString(16).slice(2);
    const client = new Paho.MQTT.Client(HOST, Number(PORT), PATH, clientId);

    client.onConnectionLost = function(resp) {
      setStatus(false);
      console.log("[MQTT] lost:", resp.errorMessage);
      setTimeout(connect, 1000); // 재시도
    };

    client.onMessageArrived = function(message) {
      const payload = message.payloadString || "";
      elRaw.textContent = payload;
      try {
        const obj = JSON.parse(payload);
        if (typeof obj.temp !== "undefined") elTemp.textContent = obj.temp + " °C";
        if (typeof obj.hum  !== "undefined") elHum.textContent  = obj.hum  + " %";
        elTs.textContent = tsToString(obj.ts);
      } catch (e) {
        console.error("JSON parse error:", e);
      }
    };

    function connect() {
      setStatus(false);
      client.connect({
        useSSL: USE_SSL,
        timeout: 10,
        cleanSession: true,
        onSuccess: function() {
          console.log("[MQTT] connected");
          setStatus(true);
          client.subscribe(TOPIC, { qos: 0 });
        },
        onFailure: function(err) {
          console.log("[MQTT] connect failed", err);
          setStatus(false);
          setTimeout(connect, 1500);
        }
      });
    }

    connect();
  </script>
</body>
</html>
